<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>게시글 상세 보기</title>
</head>
<body>

<h1>게시글 상세 정보</h1>

<div>
  <table>
    <tr>
      <th>작성자</th>
      <td th:text="${boardDTO.username}">작성자 이름</td>
    </tr>
    <tr>
      <th>제목</th>
      <td th:text="${boardDTO.title}">게시글 제목</td>
    </tr>
    <tr>
      <th>내용</th>
      <td th:text="${boardDTO.content}">게시글 내용</td>
    </tr>
    <tr>
      <th>조회수</th>
      <td th:text="${boardDTO.visitCount}">0</td>
    </tr>
    <tr>
      <th>작성 날짜</th>
      <td th:text="${#temporals.format(boardDTO.regDate, 'yyyy-MM-dd HH:mm')}">2023-01-01 10:00</td>
    </tr>
    <tr>
      <th>수정 날짜</th>
      <td th:text="${#temporals.format(boardDTO.modDate, 'yyyy-MM-dd HH:mm')}">2023-01-01 10:00</td>
    </tr>
  </table>
</div>



<div th:if="${boardDTO.fileNames != null}">
  <h3>첨부 이미지</h3>
  <div th:each="fileName : ${boardDTO.fileNames}">
    <img th:src="@{'/upload/' + ${fileName}}" alt="Image" width="200" height="200"/>
  </div>
</div>



<div>
  <a th:href="@{/board/list}">목록으로 돌아가기</a>
</div>

<a th:if="${username == boardDTO.username}"
   th:href="@{/board/modify(boardId=${boardDTO.boardId})}">
  <button type="button">수정하기</button>
</a>

<hr>

<!-- 댓글 목록 -->
<h2>댓글 목록</h2>
<div id="replyList">
  <!-- 댓글 목록이 비동기적으로 로드됩니다 -->
</div>

<!-- 댓글 작성 폼 -->
<h3>댓글 작성</h3>
<textarea id="replyText" placeholder="댓글을 작성하세요..."></textarea>
<button onclick="addReply()">댓글 추가</button>

<!-- 댓글 기능을 위한 JavaScript 추가 -->
<script th:inline="javascript">
  /* 게시글 ID와 사용자 ID 정보를 JavaScript 변수로 설정 */
  const boardId = /*[[${boardDTO.boardId}]]*/ 0;

  // 세션 유저가 없는 경우 null로 처리
  const username = /*[[${session.user != null ? session.user.username : null}]]*/ null;

  /* 댓글 목록 로드 함수 */
  async function loadReplies(page = 1) {
    const response = await fetch(`/replies/list/${boardId}?page=${page}`);
    const data = await response.json();

    const replyListDiv = document.getElementById("replyList");
    replyListDiv.innerHTML = "";

    if (data.dtoList.length > 0) { // dtoList 확인
      data.dtoList.forEach(reply => { // dtoList의 내용을 사용
        const replyDiv = document.createElement("div");
        replyDiv.innerHTML = `
          <p><strong>${reply.username}</strong>: ${reply.replyText}</p>
          ${username === reply.username ? `
              <button onclick="editReply(${reply.replyId}, '${reply.replyText}')">수정</button>
              <button onclick="deleteReply(${reply.replyId})">삭제</button>
          ` : ''}
          <hr>
        `;
        replyListDiv.appendChild(replyDiv);
      });
    } else {
      replyListDiv.innerHTML = "<p>댓글이 없습니다.</p>";
    }
  }

  /* 댓글 추가 함수 */
  async function addReply() {
    const replyText = document.getElementById("replyText").value;
    if (!replyText.trim()) {
      alert("댓글 내용을 입력하세요.");
      return;
    }

    if (!username) {
      alert("로그인이 필요합니다.");
      return;
    }

    const replyDTO = {
      boardId: boardId,
      username: username,
      replyText: replyText
    };

    const response = await fetch("/replies/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(replyDTO)
    });

    if (response.ok) {
      document.getElementById("replyText").value = "";
      loadReplies();
    } else {
      alert("댓글 등록에 실패했습니다.");
    }
  }

  /* 댓글 수정 함수 */
  async function editReply(replyId, currentText) {
    const newReplyText = prompt("수정할 댓글을 입력하세요:", currentText);
    if (newReplyText == null || newReplyText.trim() === "") return;

    const replyDTO = {
      replyId: replyId,
      replyText: newReplyText
    };

    const response = await fetch(`/replies/${replyId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(replyDTO)
    });

    if (response.ok) {
      loadReplies();
    } else {
      alert("댓글 수정에 실패했습니다.");
    }
  }

  /* 댓글 삭제 함수 */
  async function deleteReply(replyId) {
    if (!confirm("정말 이 댓글을 삭제하시겠습니까?")) return;

    const response = await fetch(`/replies/${replyId}`, {
      method: "DELETE"
    });

    if (response.ok) {
      loadReplies();
    } else {
      alert("댓글 삭제에 실패했습니다.");
    }
  }

  /* 댓글 목록 초기 로드 */
  loadReplies();
</script>

</body>
</html>
